<!DOCTYPE html>
<html>
  <head>
    <title>Chess</title>
    <link
      rel="stylesheet"
      href="{{url_for('static', filename='css/chessboard-1.0.0.min.css')}}"
    />
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="{{url_for('static', filename='js/chessboard-1.0.0.min.js')}}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>
  </head>
  <body>
    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
    <div id="input-container">
      <input type="text" id="api-key-input" placeholder="OpenAI Key" />
      <select id="model-selector">
        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
        <option value="gpt-3.5-turbo-0301">gpt-3.5-turbo-0301</option>
        <option value="gpt-4">gpt-4</option>
        <option value="gpt-4-0314">gpt-4-0314</option>
        <option value="gpt-4-32k">gpt-4-32k</option>
        <option value="gpt-4-32k-0314">gpt-4-32k-0314</option>
      </select>
      <button id="start-button">Start</button>
    </div>
    <div class="game-container" style="display: flex">
      <div id="spinner" style="display: none">
        <img alt="Loading..." />
      </div>

      <div id="board1" style="width: 400px; margin-right: 50px"></div>
      <div
        id="log"
        style="
          width: 200px;
          height: 400px;
          border: 1px solid black;
          overflow-y: auto;
          white-space: pre-wrap;
          word-wrap: break-word;
        "
      ></div>
      <div id="waiting-message" style="display: none">
        Waiting for the LLM to respond...
      </div>
    </div>
    <div id="instructions">
      <p>Read:</p>
      <ol>
        <li>
          In order for it to operate, just select the model to which you have
          access using your API key.
        </li>
        <li>You use white to play.</li>
        <li>The game will begin if the "Start" button changes to "End."</li>
        <li>
          Reload your browser or use the "End" button to restart the game.
        </li>
        <li>In the right-hand pane with a black border, logs appear.</li>
        <li>Only optimized for browser.</li>
        <li>
          In my experience, the only way to play a respectable game is with
          GPT-4. The system still needs improvement and is looking for
          contributors. Discover how it functions and how to participate here
          <a href="https://www.example.com/post">[post]</a>.
        </li>
        <li>
          Created by Max Hager (<a href="https://twitter.com/MaxHager66"
            >twitter.com/MaxHager66</a
          >)
        </li>
      </ol>
    </div>
    <script>
      var gameStarted = false;
      var selectedModel = document.getElementById("model-selector").value;
      document
        .getElementById("model-selector")
        .addEventListener("change", function () {
          selectedModel = this.value;
        });

      function updatePositionWithLoad(chess, source, target, piece) {
        // Remove the piece from the source square
        chess.remove(source);

        // Put the piece on the target square
        chess.put(piece, target);

        // Generate the FEN string for the updated position
        var updatedFen = chess.fen();

        // Load the position from the FEN string to update en passant square and castling flags
        chess.load(updatedFen);
      }

      var img_url =
        "{{ url_for('static', filename='img/chesspieces/wikipedia/') }}";
      var board1,
        game = new Chess();

      var config = {
        draggable: true,
        position: "start",
        onDragStart: onDragStart,
        onDrop: onDrop,
        onMouseoutSquare: onMouseoutSquare,
        onMouseoverSquare: onMouseoverSquare,
        onSnapEnd: onSnapEnd,
        pieceTheme: img_url + "{piece}.png",
      };

      board1 = ChessBoard("board1", config);

      function onDragStart(source, piece, position, orientation) {
        // Do not pick up pieces if the game hasn't started
        if (!gameStarted) {
          return false;
        }

        // Do not pick up pieces if the game is over
        if (game.in_checkmate() === true || game.in_draw() === true) {
          return false;
        }

        // Only pick up pieces for the side to move
        if (
          (game.turn() === "w" && piece.search(/^b/) !== -1) ||
          (game.turn() === "b" && piece.search(/^w/) !== -1)
        ) {
          return false;
        }
      }

      function onDrop(source, target) {
        // See if the move is legal
        var move = game.move({
          from: source,
          to: target,
          promotion: "q", // NOTE: always promote to a queen for simplicity
        });

        // Illegal move
        if (move === null) {
          return "snapback";
        }

        // Update the board position after a legal move
        updateStatus();

        // Check if the game is over
        if (
          game.in_checkmate() ||
          game.in_draw() ||
          game.in_stalemate() ||
          game.in_threefold_repetition() ||
          game.insufficient_material() ||
          game.half_moves >= 100
        ) {
          // Game is over, do not send the move to the server
          return;
        }

        //TODO Send the move to the server
        //sendMoveToServer(move);
      }

      function onMouseoverSquare(square, piece) {
        // Add any interaction when the mouse is over a square
      }

      function onMouseoutSquare(square, piece) {
        // Add any interaction when the mouse leaves a square
      }

      function onSnapEnd() {
        // Update the board position after the piece snap
        board1.position(game.fen());
      }

      function updateStatus() {
        var status = "";

        var moveColor = game.turn() === "w" ? "White" : "Black";

        // check for checkmate
        if (game.in_checkmate()) {
          status = "Game over, " + moveColor + " is in checkmate.";
        }

        // check for draw
        else if (game.in_draw()) {
          status = "Game over, drawn position";
        }

        // check for stalemate
        else if (game.in_stalemate()) {
          status = "Game over, stalemate";
        }

        // check for threefold repetition
        else if (game.in_threefold_repetition()) {
          status = "Game over, threefold repetition";
        }

        // check for insufficient material
        else if (game.insufficient_material()) {
          status = "Game over, insufficient material";
        }

        // check for 50-move rule
        else if (game.half_moves >= 100) {
          status = "Game over, 50-move rule";
        }

        if (status !== "") {
          displayLogMessage(status);
        }
      }

      //function for starting the game
      function startGame() {
        var apiKey = document.getElementById("api-key-input").value;
        var model = selectedModel;
        if (!apiKey) {
          alert("Please enter your OpenAI API key");
          return;
        }

        // Set API key and model in the Flask session
        $.post(
          "/set-api-key",
          { api_key: apiKey, model: model },
          function (response) {
            if (response.status === "success") {
              // Start a new session and begin the game
              $.getJSON("/new-session", function (response) {
                if (response.session_id) {
                  gameStarted = true;
                  document.getElementById("start-button").innerHTML = "End";
                } else {
                  alert("Failed to start the game");
                }
              });
            } else {
              alert("Failed to set the API key and model");
            }
          }
        );
      }

      //event listener for start and end button
      document
        .getElementById("start-button")
        .addEventListener("click", function () {
          if (gameStarted) {
            endGame();
          } else {
            startGame();
          }
        });

      //end a game
      function endGame() {
        $.getJSON("/delete-session", function (response) {
          if (response.status === "success") {
            location.reload();
          } else {
            alert("Failed to delete the session");
          }
        });
      }

      // Add this event listener to delete the session when the window is reloaded or closed
      window.addEventListener("beforeunload", function (event) {
        if (gameStarted) {
          // Asynchronous request to delete the session
          navigator.sendBeacon("/delete-session");
        }
      });
    </script>
  </body>
</html>
