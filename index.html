<!DOCTYPE html>
<html>
  <head>
    <title>Chess</title>
    <link
      rel="stylesheet"
      href="{{url_for('static', filename='css/chessboard-1.0.0.min.css')}}"
    />
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="{{url_for('static', filename='js/chessboard-1.0.0.min.js')}}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>
  </head>
  <body>
    <div id="board1" style="width: 400px"></div>
    <button id="getBestMove">Get Best Move</button>

    <script>
      function updatePositionWithLoad(chess, source, target, piece) {
        // Remove the piece from the source square
        chess.remove(source);

        // Put the piece on the target square
        chess.put(piece, target);

        // Generate the FEN string for the updated position
        var updatedFen = chess.fen();

        // Load the position from the FEN string to update en passant square and castling flags
        chess.load(updatedFen);
      }

      var img_url =
        "{{ url_for('static', filename='img/chesspieces/wikipedia/') }}";
      var board1,
        game = new Chess();

      var config = {
        draggable: true,
        position: "start",
        onDragStart: onDragStart,
        onDrop: onDrop,
        onMouseoutSquare: onMouseoutSquare,
        onMouseoverSquare: onMouseoverSquare,
        onSnapEnd: onSnapEnd,
        pieceTheme: img_url + "{piece}.png",
      };

      board1 = ChessBoard("board1", config);

      function onDragStart(source, piece, position, orientation) {
        // Do not pick up pieces if the game is over
        if (game.in_checkmate() === true || game.in_draw() === true) {
          return false;
        }

        // Only pick up pieces for the side to move
        if (
          (game.turn() === "w" && piece.search(/^b/) !== -1) ||
          (game.turn() === "b" && piece.search(/^w/) !== -1)
        ) {
          return false;
        }
      }

      function onDrop(source, target) {
        // See if the move is legal
        var move = game.move({
          from: source,
          to: target,
          promotion: "q", // NOTE: always promote to a queen for simplicity
        });

        // Illegal move
        if (move === null) {
          return "snapback";
        }

        // Send the move to the server
        sendMoveToServer(move);

        // Update the board position after a legal move
        updateStatus();
      }

      function onMouseoverSquare(square, piece) {
        // Add any interaction when the mouse is over a square
      }

      function onMouseoutSquare(square, piece) {
        // Add any interaction when the mouse leaves a square
      }

      function onSnapEnd() {
        // Update the board position after the piece snap
        board1.position(game.fen());
      }

      function updateStatus() {
        // Update game status, e.g., checkmate, draw, etc.
      }

      function simpleRequest() {
        $.ajax({
          url: "/hello",
          method: "GET",
          success: function (response) {
            console.log(response);
          },
        });
      }

      function sendMoveToServer(move) {
        $.ajax({
          url: "/move",
          method: "POST",
          data: {
            from: move.from,
            to: move.to,
            promotion: move.promotion,
          },
          success: function (response) {
            console.log(response);
            if (engine_instance.move_count === 1) {
              var bestMove = response.bestMove;
              game.move(bestMove, { sloppy: true });
              board1.position(game.fen());
            }
          },
        });
      }

      function getBestMove() {
        var currentFen = game.fen();

        $.ajax({
          url: "/best_move",
          method: "POST",
          data: { fen: currentFen },
          success: function (response) {
            var bestMove = response.move;
            game.move(bestMove, { sloppy: true });
            board1.position(game.fen());
          },
        });
      }
      // Add this line at the end of your JavaScript code
      document
        .getElementById("getBestMove")
        .addEventListener("click", getBestMove);
    </script>
  </body>
</html>
