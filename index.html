<!DOCTYPE html>
<html>
  <head>
    <title>Chess</title>
    <link
      rel="stylesheet"
      href="{{url_for('static', filename='css/chessboard-1.0.0.min.css')}}"
    />
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="{{url_for('static', filename='js/chessboard-1.0.0.min.js')}}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>
  </head>
  <body>
    <div id="input-container">
      <input type="text" id="api-key-input" placeholder="OpenAI Key" />
      <select id="model-selector">
        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
        <option value="gpt-3.5-turbo-0301">gpt-3.5-turbo-0301</option>
        <option value="gpt-4">gpt-4</option>
        <option value="gpt-4-0314">gpt-4-0314</option>
        <option value="gpt-4-32k">gpt-4-32k</option>
        <option value="gpt-4-32k-0314">gpt-4-32k-0314</option>
      </select>
      <button id="start-button">Start</button>
    </div>
    <div id="board1" style="width: 400px"></div>
    <script>
      var gameStarted = false;

      document
        .getElementById("start-button")
        .addEventListener("click", function () {
          // Get the API key from the input field
          var apiKey = document.getElementById("api-key-input").value;

          // Send the API key to the server
          $.ajax({
            url: "/set-api-key",
            method: "POST",
            data: {
              api_key: apiKey,
            },
            success: function (response) {
              if (response.status === "success") {
                gameStarted = true;
                console.log("Game started");
              } else {
                console.log("Error setting the API key");
              }
            },
          });
        });

      function updatePositionWithLoad(chess, source, target, piece) {
        // Remove the piece from the source square
        chess.remove(source);

        // Put the piece on the target square
        chess.put(piece, target);

        // Generate the FEN string for the updated position
        var updatedFen = chess.fen();

        // Load the position from the FEN string to update en passant square and castling flags
        chess.load(updatedFen);
      }

      var img_url =
        "{{ url_for('static', filename='img/chesspieces/wikipedia/') }}";
      var board1,
        game = new Chess();

      var config = {
        draggable: true,
        position: "start",
        onDragStart: onDragStart,
        onDrop: onDrop,
        onMouseoutSquare: onMouseoutSquare,
        onMouseoverSquare: onMouseoverSquare,
        onSnapEnd: onSnapEnd,
        pieceTheme: img_url + "{piece}.png",
      };

      board1 = ChessBoard("board1", config);

      function onDragStart(source, piece, position, orientation) {
        // Do not pick up pieces if the game hasn't started
        if (!gameStarted) {
          return false;
        }

        // Do not pick up pieces if the game is over
        if (game.in_checkmate() === true || game.in_draw() === true) {
          return false;
        }

        // Only pick up pieces for the side to move
        if (
          (game.turn() === "w" && piece.search(/^b/) !== -1) ||
          (game.turn() === "b" && piece.search(/^w/) !== -1)
        ) {
          return false;
        }
      }

      function onDrop(source, target) {
        // See if the move is legal
        var move = game.move({
          from: source,
          to: target,
          promotion: "q", // NOTE: always promote to a queen for simplicity
        });

        // Illegal move
        if (move === null) {
          return "snapback";
        }

        // Send the move to the server
        sendMoveToServer(move);

        // Update the board position after a legal move
        updateStatus();
      }

      function onMouseoverSquare(square, piece) {
        // Add any interaction when the mouse is over a square
      }

      function onMouseoutSquare(square, piece) {
        // Add any interaction when the mouse leaves a square
      }

      function onSnapEnd() {
        // Update the board position after the piece snap
        board1.position(game.fen());
      }

      function updateStatus() {
        // Update game status, e.g., checkmate, draw, etc.
      }

      function sendMoveToServer(move) {
        $.ajax({
          url: "/move",
          method: "POST",
          data: {
            from: move.from,
            to: move.to,
            promotion: move.promotion,
          },
          success: function (response) {
            console.log(response);
            // Check if response.bestMove exists
            if (response.move) {
              var move = response.move;
            } else {
              // Fallback to parsing the string if response.bestMove is not available
              var move = response.split("move:")[1]?.trim().split(" ")[0];
            }
            if (move) {
              game.move(move, { sloppy: true });
              board1.position(game.fen());
            }
          },
        });
      }
    </script>
  </body>
</html>
